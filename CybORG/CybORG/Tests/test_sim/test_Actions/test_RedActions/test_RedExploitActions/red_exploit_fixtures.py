import inspect

import pytest

from CybORG import CybORG
from CybORG.Agents import DebuggingAgent
from CybORG.Shared.Enums import TrinaryEnum, OperatingSystemType
from CybORG.Shared.Actions.ConcreteActions.ExploitAction import ExploitAction
from CybORG.Shared.Actions.ConcreteActions.BlueKeep import BlueKeep
from CybORG.Shared.Actions.ConcreteActions.EternalBlue import EternalBlue
from CybORG.Shared.Actions.ConcreteActions.HTTPRFI import HTTPRFI
from CybORG.Shared.Actions.ConcreteActions.HTTPSRFI import HTTPSRFI
from CybORG.Shared.Actions.ConcreteActions.SSHBruteForce import SSHBruteForce
from CybORG.Tests.EphemeralPort import Win2008EphemeralPort, LinuxEphemeralPort

HOSTNAMES = ['User1', 'User2', 'User3', 'User4','Enterprise0','Enterprise1','Enterprise2',
            'Op_Server0','Op_Host0','Op_Host1','Op_Host2']

@pytest.fixture
def cyborg(agents = {},seed = 1):
    path = str(inspect.getfile(CybORG))
    path = path[:-10] + '/Shared/Scenarios/Scenario2.yaml'
    cyborg = CybORG(path, 'sim', agents=agents)
    cyborg.set_seed(seed)
    return cyborg

@pytest.fixture
def params():
    return {'session':0,'agent':'Red', 'target_session':0}

@pytest.fixture
def obs_failure():
    return {'success': TrinaryEnum.FALSE}

def _compute_red_killchain(cyborg,hostnames,priority=None):
    results = cyborg.reset(agent='Red')
    obs = results.observation
    
    ip_map = cyborg.get_ip_map()
    ip_list = [ip_map[h] for h in hostnames]
    agent = DebuggingAgent(ip_list=ip_list,priority=priority)

    history = []
    for i in range(39):
        try:
            action = agent.get_action(obs)
        except:
            break
        results = cyborg.step(agent='Red',action=action)

        name = results.action.__class__.__name__
        host = None
        if 'Exploit' in name:
            name = results.action.sub_action.__class__.__name__
            ip_map = cyborg.get_ip_map()
            host_index = list(ip_map.values()).index(results.action.ip_address)
            host = list(ip_map.keys())[host_index]
        obs = results.observation
        history.append((name,obs,host))
    
    return {'history':history,'cyborg':cyborg}

@pytest.fixture
def red_killchain(cyborg):
    return _compute_red_killchain(cyborg,HOSTNAMES)

@pytest.fixture
def prioritised_killchain():
    return _compute_red_killchain

